<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OrgBuilder - User Content</title>
    <link rel="stylesheet" type="text/css" href="../css/org-styles.css" />
</head>
<body>
    <h1>User Content</h1>

    <p>
        <a id="logoutButton" href="../index.html">Logout</a>
    </p>
    <p>
        <a id="mainMenuButton" href="../main.html">Main Menu</a>
    </p>

    <h3>Content</h3>

    <form id="userDetailsForm" action="javascript:void(0)">
        <div id="infoDiv">
            <h5>User Info</h5>
            <table>
                <tr>
                    <td field="label">Email</td>
                    <td field="input">
                        <input id="userEmailField" name="userEmail" type="text" required />
                    </td>
                    <td>*</td>
                </tr>
                <tr>
                    <td field="label">First Name</td>
                    <td field="input">
                        <input id="firstNameField" name="firstName" type="text" />
                    </td>
                </tr>
                <tr>
                    <td field="label">Last Name</td>
                    <td field="input">
                        <input id="lastNameField" name="lastName" type="text" />
                    </td>
                </tr>
            </table>
        </div>
        <div id="passwordDiv">
            <h5>Password</h5>
            <!-- TODO in the long run, need a much better system for changing passwords. Emails with temporary codes, etc -->
            <div id="editPasswordBtnDiv" class="hidden">
                <button id="editPasswordBtn" type="button" title="Change the existing password for this user.">Change Password</button>
            </div>
            <div id="editPasswordDiv" class="hidden">
                <button id="cancelEditPasswordBtn" type="button" title="Cancel the change to the password for this user, and maintain the existing password.">Cancel Password Change</button>
                <table>
                    <tr>
                        <td field="label">Password</td>
                        <td field="input">
                            <input id="firstPassField" name="firstPass" type="password" required />
                        </td>
                        <td>*</td>
                    </tr>
                    <tr>
                        <td field="label">Repeat Password</td>
                        <td field="input">
                            <input id="secondPassField" name="secondPass" type="password" required />
                        </td>
                        <td>*</td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="accessDiv">
            <h5>Access</h5>
            <div id="accessCheckboxes">
                <!-- This is where the checkboxes for the roles will go -->
            </div>
        </div>
        <div id="orgDiv">
            <h5>Org</h5>
            <input id="orgIdField" name="orgId" type="hidden" />
            <div id="orgDisplayDiv">
                <table>
                    <tr>
                        <td field="label">Org Name</td>
                        <td field="input">
                            <input id="orgNameField" name="orgName" type="text" disabled />
                        </td>
                    </tr>
                </table>
            </div>
            <div id="orgSelectDiv" class="hidden">
                <table>
                    <tr>
                        <td field="label">Org Name</td>
                        <td field="input">
                            <select id="orgSelectBox">
                            </select>
                        </td>
                        <td>*</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="buttonDiv">
            <button id="cancelBtn" type="button" title="Cancel changes">Cancel</button>
            <button id="saveBtn" type="button" title="Save changes">Save</button>
        </div>
    </form>
<script src="../jquery-3.1.1.js"></script>
<script src="../URI.js"></script>
<script src="../js/org-props.js"></script>
<script src="../js/orgbuilder.js"></script>
<script>
    $(document).ready(function(){
        //TODO the Org Name fields needs to be filled in for the add user page, using the user from the admin principal
        //TODO if a master principal, an option to select the org the user belongs to should be provided only for add user.
        //TODO need to assign an orgId, for both admin and master principals, and that orgId should be submitted for both add and edit operations
        $("#logoutButton").click(orgbuilder.jwt.clearToken);
        $("#mainMenuButton").click(orgbuilder.cancelChangesCheck);

        var url = URI(window.location.href);
        if(url.hasQuery("userid")){
            var userid = url.search(true).userid;
        }

        function invalidCredentialsFn(){
            console.log("Invalid credentials to access user content editor.");
            window.location = "../access-denied.html";
        }

        var payload = orgbuilder.jwt.getTokenPayload();
        if(payload === null){
            invalidCredentialsFn();
            return;
        }

        if(!orgbuilder.validateAccess.anyRole(orgbuilder.roles.master, orgbuilder.roles.admin) &&
            userid != payload.uid){
            //TODO this needs to be tested with an individual non-admin non-master user accessing their own account
            invalidCredentialsFn();
            return;
        }

        var accessCheckboxes = $("#accessCheckboxes");

        function appendCheckboxFn(role, isDisabled){
            var disabled = isDisabled ? "disabled" : "";
            var id = "select" + role;
            var inputCheckbox = $("<input id='" + id + "' name='" + role + "' type='checkbox' " + disabled + "/>");
            $(accessCheckboxes).append(inputCheckbox);
            $(accessCheckboxes).append($("<label for='" + id + "'></label>").text(role));
            $(accessCheckboxes).append("<br />");

            return inputCheckbox;
        }

        //TODO need to add a check to warn the user if they try and save changes with no roles selected

        var rolesDisabled = !orgbuilder.jwt.hasRole(orgbuilder.roles.admin) && !orgbuilder.jwt.hasRole(orgbuilder.roles.master);

        if(userid){
            //Configure for an Edit User page
            $("#editPasswordBtnDiv").removeClass("hidden");

            orgbuilder.api.send("users/" + userid, orgbuilder.methods.get)
                .done(function(userData){
                    if(!orgbuilder.validateData.user(userData)){
                        console.log("Error! Data returned from server for User does not contain the User.");
                        window.location = "../server-error.html";
                        return;
                    }
                    $("#userEmailField").val(userData.userEmail);
                    $("#firstNameField").val(userData.firstName);
                    $("#lastNameField").val(userData.lastName);
                    $("#orgNameField").val(userData.orgName);
                    $("#orgIdField").val(userData.orgId);

                    if(userData.roles.includes(orgbuilder.roles.master)){
                        appendCheckboxFn(orgbuilder.roles.master, true).prop("checked", true);
                    }
                    else{
                        $.each(orgbuilder.roles, function(index,role){
                            if(role !== orgbuilder.roles.master){
                                var inputCheckbox = appendCheckboxFn(role, rolesDisabled);
                                if(userData.roles.includes(role)){
                                    $(inputCheckbox).prop("checked", true);
                                }
                            }
                        });
                    }
                })
                .fail(function(){
                    //TODO need better fail behavior
                    console.log("FAILED TO RETRIEVE USER DETAILS");
                });
        }
        else{
            //Configure for an add user page
            $("#editPasswordDiv").removeClass("hidden");
            $("#cancelEditPasswordBtn").addClass("hidden");
            if(orgbuilder.jwt.hasRole(orgbuilder.roles.master)){
                appendCheckboxFn(orgbuilder.roles.master, rolesDisabled);
                var orgSelectBox = $("#orgSelectBox");
                $("#orgSelectDiv").removeClass("hidden");
                $("#orgDisplayDiv").addClass("hidden");

                orgbuilder.api.send("orgs", orgbuilder.methods.get)
                    .done(function(orgData){
                        if(!orgbuilder.validateData.orgList(orgData)){
                            console.log("Error! Data returned from server for OrgList does not contain the OrgList.");
                            window.location = "../server-error.html";
                            return;
                        }

                        $.each(orgData.orgList, function(index, org){
                            var option = $("<option></option>").attr("value", org.orgId).text(org.orgName);
                            $(orgSelectBox).append(option);
                        });

                        setOrgIdFromSelect();
                    })
                    .fail(function(){
                        //TODO need better fail behavior
                        console.log("FAILED TO RETRIEVE LIST OF ORGS");
                    });
            }
            else{
                $("#orgNameField").val(payload.onm);
                $("#orgIdField").val(payload.oid);
            }

            $.each(orgbuilder.roles, function(index,role){
                if(role !== orgbuilder.roles.master){
                    appendCheckboxFn(role, rolesDisabled);
                }
            });
        }

        $("#select" + orgbuilder.roles.master).change(function(){
            var checked = this.checked;
            $(accessCheckboxes).children("input[type = 'checkbox']").each(function(index,input){
                if($(input).attr("id") !== "select" + orgbuilder.roles.master){
                    $(input).prop("checked", false);
                    $(input).prop("disabled", checked);
                }
            });

            if(orgbuilder.jwt.hasRole(orgbuilder.roles.master) && checked){
                $("#orgSelectDiv").addClass("hidden");
            }
            else if(orgbuilder.jwt.hasRole(orgbuilder.roles.master)){
                $("#orgSelectDiv").removeClass("hidden");
            }
        });

        function setOrgIdFromSelect(){
            var selected = $("#orgSelectBox :selected");
            $("#orgIdField").val($(selected).val());
        }

        $("#orgSelectBox").change(setOrgIdFromSelect);

        $("#editPasswordBtn").click(function(){
            $("#editPasswordBtnDiv").addClass("hidden");
            $("#editPasswordDiv").removeClass("hidden");
        });

        $("#cancelEditPasswordBtn").click(function(){
            $("#editPasswordBtnDiv").removeClass("hidden");
            $("#editPasswordDiv").addClass("hidden");
        });

        $("#cancelBtn").click(function(event){
            event.preventDefault();
            if(orgbuilder.cancelChangesCheck()){
                console.log("Cancelling changes to User details");
                if(orgbuilder.jwt.hasRole(orgbuilder.roles.master) || orgbuilder.jwt.hasRole(orgbuilder.roles.admin)){
                    window.location = "manage.html";
                }
                else{
                    window.location = "../main.html";
                }
            }
        });

        //Perform the save operation
        $("#saveBtn").click(function(event){
            event.preventDefault();
            console.log("Saving changes to User");

            var allComplete = orgbuilder.checkRequiredFields("userDetailsForm");
            if(!allComplete){
                return;
            }

            //Need to check that the two password fields match each other
            if($("#editPasswordDiv").is(":visible") && $("#firstPassField").val() !== $("#secondPassField").val()){
                alert("Passwords do not match");
                return;
            }

            var doneFn = function(){
                if(orgbuilder.jwt.hasRole(orgbuilder.roles.master) || orgbuilder.jwt.hasRole(orgbuilder.roles.admin)){
                    window.location = "manage.html";
                }
                else{
                    window.location = "../main.html";
                }
            };

            var failFn = function(){
                //TODO need some sort of fail behavior
                console.log("Save FAILED");
            };

            var jsonMsg = {
                userEmail: $("#userEmailField").val(),
                firstName: $("#firstNameField").val(),
                lastName: $("#lastNameField").val(),
                password: (function(){
                    if($("#editPasswordDiv").is(":visible")){
                        return $("#firstPassField").val();
                    }
                    return null;
                })(),
                roles: (function(){
                    var roles = [];
                    $("#accessCheckboxes input[type = 'checkbox']").each(function(index,input){
                        if($(input).is(":checked")){
                            roles.push($(input).attr("name"));
                        }
                    });
                    return roles;
                })(),
                orgId: (function(){
                    var selectMaster = $("#select" + orgbuilder.roles.master);
                    if($(selectMaster).length > 0 && $($(selectMaster)[0]).is(":checked")){
                        return null;
                    }
                    return $("#orgIdField").val();
                })()
            };

            if(userid){
                console.log("Updating existing User");
                orgbuilder.api.send("users/" + userid, orgbuilder.methods.put, jsonMsg)
                    .done(doneFn).fail(failFn);
            }
            else{
                console.log("Creating new User");
                orgbuilder.api.send("users", orgbuilder.methods.post, jsonMsg)
                    .done(doneFn).fail(failFn);
            }
        });
    });
</script>
</body>
</html>