<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OrgBuilder</title>
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/org-styles.css" />
</head>
<body>
<!-- Navbar -->
<div id="navbar-container">
    <!-- Placeholder container for the navbar from the template -->
</div>
<!-- Wrapper around sidebar and page content -->
<div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-container">
        <!-- Placeholder container for the sidebar from the template -->
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12 col-md-6 col-md-offset-3">
                    <div class="page-header">
                        <h1>Welcome to <span class="org-brand">OrgBuilder</span></h1>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TODO FC-4 -->
<script src="jquery-3.1.1.js"></script>
<script src="bootstrap/js/bootstrap.js"></script>
<script src="js/org-props.js"></script>
<script src="js/orgbuilder.js"></script>
<script>
    $(document).ready(function(){

        /*************************
         * 1) Top Scope Variables
         *************************/



        /*******************************
         * 2) Access to Page Validation
         *******************************/

        //If no token exists, simply re-direct to the login page
        if(!orgbuilder.validateAccess().hasToken().isValid()){
            console.log("User needs to log in");
            window.location = "login.html";
            return;
        }
        else{
            //Otherwise, attempt to validate that the token hasn't expired
            orgbuilder.api.send("/auth/check", orgbuilder.methods.get);
        }

        /****************
         * 3) UI Actions
         ****************/



        /***********************************
         * 4) Core Business Logic Functions
         ***********************************/

        function toggleMenu(event){
            event.preventDefault();
            $("#sidebar-wrapper .menu-collapse").collapse("hide");
            $("#wrapper").toggleClass("display-menu");
        }

        function parentItemAction(event){
            $("#sidebar-wrapper .menu-collapse").collapse("hide");
            if(!$("#wrapper").hasClass("display-menu")){
                $("#wrapper").addClass("display-menu");
            }
        }

        /***********************
         * 5) Utility Functions
         ***********************/

        /*************************
         * 6) Page Initialization
         *************************/

        //TODO move this all into a utility method, along with any additional JS code from here that would be needed
        $.get("template/menus-template.html")
            .done(function(data){
                var navbar = $(data).filter("#navbar-template");
                var sidebar = $(data).filter("#sidebar-template");
                $("#navbar-container").html(navbar);
                $("#sidebar-container").html(sidebar);

                //Assign UI actions
                $("#menu-toggle").click(toggleMenu);
                $(".sidebar-parent-item").click(parentItemAction);
                $("#logoutBtn").click(orgbuilder.jwt.clearToken);

                //Display dynamic values in navbar
                $("#userName").text(orgbuilder.jwt.getTokenPayload().unm);
                if(orgbuilder.jwt.getTokenPayload().onm !== ""){
                    $(".org-brand").text(orgbuilder.jwt.getTokenPayload().onm);
                }

                //Fix path to index.html
                $("a.navbar-brand.org-brand").attr("href", orgProps.clientOrigin + "/index.html");
            })
            .fail(function(jqXHR){
                //TODO TC-3
                console.log("Failed to log template. Status: " + jqXHR.status);
            });
    });
</script>
</body>
</html>