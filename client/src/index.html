<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OrgBuilder</title>
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/org-styles.css" />
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!-- Navbar Header -->
        <div class="navbar-header">
            <a class="navbar-brand org-brand" href="index.html">OrgBuilder</a>
        </div>

        <!-- Navbar Items -->
        <div>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" class="dropdown-toggle expandable" data-toggle="dropdown">
                        <i class="glyphicon glyphicon-user"></i> <span id="userName">User</span> <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#">
                                <i class="glyphicon glyphicon-user"></i> User Profile
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="glyphicon glyphicon-globe"></i> Org Profile
                            </a>
                        </li>
                        <li>
                            <a id="logoutBtn" href="login.html"> <!-- TODO when this is turned into a template, probably will need an absolute path for this -->
                                <i class="glyphicon glyphicon-off"></i> Logout
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
<!-- Wrapper around sidebar and page content -->
<div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav nav flex-column">
            <li>
                <a id="menu-toggle" href="#">
                    <i class="glyphicon glyphicon-menu-hamburger"></i><span class="sidebar-text"> Menu</span>
                </a>
            </li>
            <li class="active">
                <a href="#">
                    <i class="glyphicon glyphicon-home"></i><span class="sidebar-text"> Home</span>
                </a>
            </li>
            <li>
                <a href="#" class="sidebar-parent-item expandable" data-toggle="collapse" data-target="#orgs-collapse">
                    <i class="glyphicon glyphicon-globe"></i><span class="sidebar-text"> Orgs <span class="caret"></span></span>
                </a>
                <ul id="orgs-collapse" class="collapse menu-collapse">
                    <li>
                        <a href="#">Manage</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#" class="sidebar-parent-item expandable" data-toggle="collapse" data-target="#users-collapse">
                    <i class="glyphicon glyphicon-user"></i><span class="sidebar-text"> Users <span class="caret"></span></span>
                </a>
                <ul id="users-collapse" class="collapse menu-collapse">
                    <li>
                        <a href="#">Manage</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#" class="sidebar-parent-item expandable" data-toggle="collapse" data-target="#members-collapse">
                    <i class="glyphicon glyphicon-signal"></i><span class="sidebar-text"> Members <span class="caret"></span></span>
                </a>
                <ul id="members-collapse" class="collapse menu-collapse">
                    <li>
                        <a href="#">Manage</a>
                    </li>
                </ul>
            </li>
        </ul>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12 col-md-6 col-md-offset-3">
                    <div class="page-header">
                        <h1>Welcome to <span class="org-brand">OrgBuilder</span></h1>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="jquery-3.1.1.js"></script>
<script src="bootstrap/js/bootstrap.js"></script>
<script src="js/org-props.js"></script>
<script src="js/orgbuilder.js"></script>
<script>
    $(document).ready(function(){

        /*************************
         * 1) Top Scope Variables
         *************************/



        /*******************************
         * 2) Access to Page Validation
         *******************************/

        //If no token exists, simply re-direct to the login page
        if(!orgbuilder.validateAccess().hasToken().isValid()){
            console.log("User needs to log in");
            window.location = "login.html";
            return;
        }
        else{
            //Otherwise, attempt to validate that the token hasn't expired
            orgbuilder.api.send("/auth/check", orgbuilder.methods.get);
        }

        /****************
         * 3) UI Actions
         ****************/

        $("#menu-toggle").click(toggleMenu);
        $(".sidebar-parent-item").click(parentItemAction);
        $("#logoutBtn").click(orgbuilder.jwt.clearToken);

        /***********************************
         * 4) Core Business Logic Functions
         ***********************************/

        function toggleMenu(event){
            event.preventDefault();
            $("#sidebar-wrapper .menu-collapse").collapse("hide");
            $("#wrapper").toggleClass("display-menu");
        }

        function parentItemAction(event){
            $("#sidebar-wrapper .menu-collapse").collapse("hide");
            if(!$("#wrapper").hasClass("display-menu")){
                $("#wrapper").addClass("display-menu");
            }
        }

        /***********************
         * 5) Utility Functions
         ***********************/

        /*************************
         * 6) Page Initialization
         *************************/

        //Check that the access token is still valid
        orgbuilder.api.send("/auth/check", orgbuilder.methods.get);

        //Display dynamic values in navbar
        $("#userName").text(orgbuilder.jwt.getTokenPayload().unm);
        if(orgbuilder.jwt.getTokenPayload().onm !== ""){
            $(".org-brand").text(orgbuilder.jwt.getTokenPayload().onm);
        }

        //Fix path to index.html
        $("a.navbar-brand.org-brand").attr("href", orgProps.clientOrigin + "/index.html");

    });
</script>
</body>
</html>