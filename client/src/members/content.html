<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OrgBuilder - Member Content</title>
    <link rel="stylesheet" type="text/css" href="../bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../css/org-styles.css" />
</head>
<body>
<!-- Navbar -->
<div id="navbar-container">
    <!-- Placeholder container for the navbar from the template -->
</div>
<!-- Wrapper around sidebar and page content -->
<div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-container">
        <!-- Placeholder container for the sidebar from the template -->
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-12">
                    <div class="page-header">
                        <h2 name=""></h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12 col-sm-8 col-sm-offset-2">
                    <div id="actionAlert" class="alert fade">
                        <a href="#" class="close" data-hide="alert" aria-label="close">&times;</a>
                        <p></p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12 col-sm-8 col-sm-offset-2">
                    <form id="memberContentForm" class="no-enter-form">
                        <div class="row">
                            <div class="col-sm-12">
                                <div id="memberInfoSection" class="panel panel-primary form-group" status="view">
                                    <div class="panel-heading clearfix">
                                        <h4 class="pull-left">Personal Info</h4>
                                        <div class="btn-group pull-right section-toggle">
                                            <button class="section-edit btn btn-info" type="button" title="Edit Section">Edit</button>
                                            <button class="section-save btn btn-primary" type="submit" title="Save Section">Save</button>
                                        </div>
                                    </div>
                                    <div class="panel-body">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <p class="content-name">First Name:</p>
                                            </div>
                                            <div id="firstNameField" class="content col-sm-6">
                                                <p class="content-label"></p>
                                                <input name="firstName" class="content-field form-control" type="text" disabled />
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <p class="content-name">Middle Name:</p>
                                            </div>
                                            <div id="middleNameField" class="content col-sm-6">
                                                <p class="content-label"></p>
                                                <input name="middleName" class="content-field form-control" type="text" disabled />
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <p class="content-name">Last Name:</p>
                                            </div>
                                            <div id="lastNameField" class="content col-sm-6">
                                                <p class="content-label"></p>
                                                <input name="lastName" class="content-field form-control" type="text" disabled />
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <p class="content-name">Date of Birth:</p>
                                            </div>
                                            <div id="birthDateField" class="content col-sm-6">
                                                <p class="content-label"></p>
                                                <input name="dateOfBirth" class="content-field form-control" type="date" disabled />
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <p class="content-name">Sex:</p>
                                            </div>
                                            <div id="sexField" class="content col-sm-6">
                                                <p class="content-label"></p>
                                                <select id="sexSelectBox" name="sex" class="content-field form-control"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <div id="memberAddressSection" class="panel panel-primary form-group" status="view">
                                    <div class="panel-heading clearfix">
                                        <h4 class="pull-left">Addresses</h4>
                                        <div class="btn-group pull-right section-toggle">
                                            <button class="section-edit btn btn-info" type="button" title="Edit Section">Edit</button>
                                            <button class="section-save btn btn-primary" type="submit" title="Save Section">Save</button>
                                        </div>
                                    </div>
                                    <div class="panel-body">
                                        <div id="addressContainer">
                                            <!-- Addresses will go here -->
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-12">
                                                <button id="addAddressBtn" class="content-btn btn btn-primary modal-btn" type="button" title="Add Address" data-target="#address-modal">Add</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <div id="memberPhoneSection" class="panel panel-primary form-group" status="view">
                                    <div class="panel-heading clearfix">
                                        <h4 class="pull-left">Phones</h4>
                                        <div class="btn-group pull-right section-toggle">
                                            <button class="section-edit btn btn-info" type="button" title="Edit Section">Edit</button>
                                            <button class="section-save btn btn-primary" type="submit" title="Save Section">Save</button>
                                        </div>
                                    </div>
                                    <div class="panel-body">
                                        <div id="phoneContainer">
                                            <!-- Phones will go here -->
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-12">
                                                <button id="addPhoneBtn" class="content-btn btn btn-primary modal-btn" type="button" title="Add Phone" data-target="#phone-modal">Add</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <div id="memberEmailSection" class="panel panel-primary form-group" status="view">
                                    <div class="panel-heading clearfix">
                                        <h4 class="pull-left">Emails</h4>
                                        <div class="btn-group pull-right section-toggle">
                                            <button class="section-edit btn btn-info" type="button" title="Edit Section">Edit</button>
                                            <button class="section-save btn btn-primary" type="submit" title="Save Section">Save</button>
                                        </div>
                                    </div>
                                    <div class="panel-body">
                                        <div id="emailContainer">
                                            <!-- Emails will go here -->
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-12">
                                                <button id="addEmailBtn" class="content-btn btn btn-primary modal-btn" type="button" title="Add Email" data-target="#email-modal">Add</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <a id="cancelBtn" href="manage.html" class="btn btn-primary" type="button" title="Cancel changes">Cancel</a>
                                <button id="saveBtn" class="btn btn-success" type="submit" title="Save changes">Save</button>
                                <a id="deleteBtn" class="btn btn-danger pull-right" type="button" title="Delete Member">Delete</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
    <div id="modal-wrapper">
        <!-- Modals go here -->
    </div>
    <div id="address-modal" class="modal org-modal contact-modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"><span class="title-type"></span> Address</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-name">Address Type:</p>
                        </div>
                        <div class="col-sm-6">
                            <select id="addressTypeSelect" name="addressType" class="form-control" />
                            <!-- TODO need to populate this -->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-name">Address Line 1:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="address1Field" name="address1" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-name">Address Line 2:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="address2Field" name="address2" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-name">City:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="cityField" name="city" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-name">State:</p>
                        </div>
                        <div class="col-sm-6">
                            <!-- TODO need to populate this select with values -->
                            <select id="stateField" name="state" class="form-control"></select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-name">Zip Code:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="zipCodeField" name="zipCode" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-6">
                            <label for="primaryAddressField">
                                <input id="primaryAddressField" name="primary" class="" type="checkbox">
                                Primary
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-no btn btn-primary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="modal-yes btn btn-success" data-dismiss="modal">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div id="phone-modal" class="modal org-modal contact-modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"><span class="title-type"></span> Phone</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-label">Phone Type:</p>
                        </div>
                        <div class="col-sm-6">
                            <select id="phoneTypeSelect" name="phoneType" class="form-control"></select>
                            <!-- TODO need to populate this -->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-label">Area Code:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="areaCodeField" name="areaCode" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-label">Prefix:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="prefixField" name="prefix" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-label">Line Number:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="lineNumberField" name="lineNumber" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-label">Extension:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="extensionField" name="extension" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-6">
                            <label for="primaryPhoneField">
                                <input id="primaryPhoneField" name="primary" class="" type="checkbox">
                                Primary
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-no btn btn-primary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="modal-yes btn btn-success" data-dismiss="modal">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div id="email-modal" class="modal org-modal contact-modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"><span class="title-type"></span> Email</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-label">Email Type:</p>
                        </div>
                        <div class="col-sm-6">
                            <select id="emailTypeSelect" name="emailType" class="form-control"></select>
                            <!-- TODO need to populate this -->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p class="content-label">Email:</p>
                        </div>
                        <div class="col-sm-6">
                            <input id="emailField" name="emailAddress" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-6">
                            <label for="primaryEmailField">
                                <input id="primaryEmailField" name="primary" class="" type="checkbox">
                                Primary
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-no btn btn-primary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="modal-yes btn btn-success" data-dismiss="modal">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TODO FC-4 -->
<script src="../jquery-3.1.1.js"></script>
<script src="../URI.js"></script>
<script src="../bootstrap/js/bootstrap.js"></script>
<script src="../js/org-props.js"></script>
<script src="../js/orgbuilder.js"></script>
<script>
    $(document).ready(function(){

        /*************************
         * 1) Top Scope Variables
         *************************/

        var currentUrl = URI(window.location.href);
        var memberId = (function(){
            if(currentUrl.hasQuery("memberId")){
                return currentUrl.search(true).memberId;
            }
        })();
        var saved = (function(){
            if(currentUrl.hasQuery("saved")){
                return true;
            }
        })();

        /*******************************
         * 2) Access to Page Validation
         *******************************/

        //TODO going to need something here...

        /****************
         * 3) UI Actions
         ****************/

        $(".section-edit").click(toggleEdit);
        $("#memberContentForm").on("submit", submitAction);
        $("#deleteBtn").click(deleteMember);
        $("#cancelBtn").click(orgbuilder.cancelChangesCheck);
        $(".modal-btn").click(showContactModal);

        /***********************************
         * 4) Core Business Logic Functions
         ***********************************/

        function toggleEdit(event){
            $("#sexSelectBox").val(orgbuilder.data.getData().sex);
            orgbuilder.content.toggleEdit(event);
        }

        function submitAction(event){
            orgbuilder.content.memberSubmitAction(event, memberId);
        }

        function loadMember(){
            orgbuilder.api.send("members/" + memberId, orgbuilder.methods.get)
                .done(function(memberData, status, jqXHR){
                    if(jqXHR.status === 204){
                        console.log("Member not found on server");
                        orgbuilder.showAlert("alert-danger", "Member not found on server");
                        return;
                    }

                    updateFields(memberData);
                });
        }

        function loadInfo(){
            orgbuilder.api.send("info", orgbuilder.methods.get)
                .done(function(infoData, status, jqXHR){
                    if(!orgbuilder.validateData.infoAll(infoData)){
                        console.log("Error! Data returned from server for Info does not contain the Info.");
                        orgbuilder.showAlert("alert-danger", "Invalid data returned from server for General Info.");
                        return;
                    }

                    var sexSelectBox = $("#sexSelectBox");
                    $.each(infoData.sexes, function(index, sex){
                        var option = $("<option></option>").attr("value", sex).attr("name", sex).text(sex);
                        $(sexSelectBox).append(option);
                    });

                    var addressTypeSelect = $("#addressTypeSelect");
                    var phoneTypeSelect = $("#phoneTypeSelect");
                    var emailTypeSelect = $("#emailTypeSelect");

                    $.each(infoData.contactTypes.addressTypes, function(index, type){
                        var option = $("<option></option>").attr("value", type).attr("name", type).text(type);
                        $(addressTypeSelect).append(option);
                    });

                    $.each(infoData.contactTypes.phoneTypes, function(index, type){
                        var option = $("<option></option>").attr("value", type).attr("name", type).text(type);
                        $(phoneTypeSelect).append(option);
                    });

                    $.each(infoData.contactTypes.emailTypes, function(index, type){
                        var option = $("<option></option>").attr("value", type).attr("name", type).text(type);
                        $(emailTypeSelect).append(option);
                    });
                });
        }

        function deleteMember(event){
            if(event){
                event.preventDefault();
            }

            var item = $(".page-header > h2").attr("name");
            orgbuilder.modal.showDelete(item, function(){
                orgbuilder.api.send("members/" + memberId, orgbuilder.methods.delete)
                    .done(function(){
                        window.location = "manage.html";
                    });
            });
        }

        /***********************
         * 5) Utility Functions
         ***********************/

        function updateFields(memberData){
            if(!orgbuilder.validateData.member(memberData)){
                console.log("Error! Data returned from server for Member does not contain the Member.");
                orgbuilder.showAlert("alert-danger", "Invalid data returned from server for Member.");
                return;
            }

            orgbuilder.data.storeData(memberData);

            var firstLastName = memberData.firstName + " " + memberData.lastName;

            $(".page-header > h2").text("Member: " + firstLastName);
            $(".page-header > h2").attr("name", firstLastName);

            $("#firstNameField > .content-label").text(memberData.firstName);
            $("#firstNameField > .content-field").val(memberData.firstName);

            $("#middleNameField > .content-label").text(memberData.middleName);
            $("#middleNameField > .content-field").val(memberData.middleName);

            $("#lastNameField > .content-label").text(memberData.lastName);
            $("#lastNameField > .content-field").val(memberData.lastName);

            //TODO need to make sure age is recalculated after editing birth date value
            var age = (function(){
                if(memberData.dateOfBirth){
                    return " (" + orgbuilder.calculateAge(memberData.dateOfBirth) + ")";
                }
                return ""
            })();

            $("#birthDateField > .content-label").text(memberData.dateOfBirth + age);
            $("#birthDateField > .content-field").val(new Date(memberData.dateOfBirth).toISOString().substr(0,10));

            $("#sexField > .content-label").text(memberData.sex);
        }

        function showContactModal(event){
            var target = $(event.target).attr("data-target");
            $(target).modal({
                backdrop: "static"
            });
        }

        /*************************
         * 6) Page Initialization
         *************************/

        orgbuilder.menus.loadMainTemplate("sidebar-members-btn");
        loadInfo();

        if(memberId){
            //Configure for edit member page
            loadMember();
        }
        else{
            //Configure for new member page
            $(".page-header > h2").text("New Member");
            $(".panel.form-group").attr("status", "edit");
            $(".section-toggle").addClass("hidden");
            $(".content-field").removeAttr("disabled");
            $("#deleteBtn").addClass("hidden");
        }

    });
</script>
</body>
</html>