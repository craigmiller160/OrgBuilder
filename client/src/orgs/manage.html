<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OrgBuilder - Manage Orgs</title>
    <link rel="stylesheet" type="text/css" href="../css/org-styles.css" />
</head>
<body>
    <h1>Manage Orgs</h1>
    <p>
        <a id="logoutButton" href="../index.html">Logout</a>
    </p>
    <p>
        <a id="mainMenuButton" href="../main.html">Main Menu</a>
    </p>

    <h3>Orgs</h3>

    <table id="orgsTable" border="1">
        <thead>
            <tr>
                <th>Org Name</th>
                <th>Created Date</th>
                <th>Options</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button id="addOrgBtn" type="button" title="Add new Org">A</button>

<script src="../jquery-3.1.1.js"></script>
<script src="../js/org-props.js"></script>
<script src="../js/orgbuilder.js"></script>
<script>
    $(document).ready(function(){
        $("#logoutButton").click(orgbuilder.jwt.clearToken);
        if(!orgbuilder.validateAccess(orgbuilder.roles.master)){
            console.log("Invalid credentials to access org manager!");
            window.location = "../access-denied.html";
            return;
        }

        var tableBody = $("#orgsTable tbody");

        function validateData(data){
            return data.orgList !== undefined && data.orgList !== null;
        }

        //TODO need to add pagination
        orgbuilder.api.call("orgs", orgbuilder.methods.get)
            .done(function(data,status,jqXHR){
                if(!validateData(data)){
                    //TODO consider better error handling here
                    window.location = "../server-error.html";
                    return;
                }
                $.each(data.orgList, function(index, org){
                    var newRow = $("<tr index='" + index + "' orgid='" + org.orgId + "'></tr>");
                    newRow.append($("<td field='orgName'></td>").text(org.orgName));
                    newRow.append($("<td field='createdDate'></td>").text(org.createdDate));

                    var options = $("<td field='options'></td>");
                    options.append($("<button class='editOrgBtn' type='button' title='Edit Org'></button>").text("E"));
                    options.append($("<button class='deleteOrgBtn' type='button' title='Delete Org'></button>").text("D"));


                    newRow.append(options);
                    tableBody.append(newRow);
                });

                $(".editOrgBtn").click(function(event){
                    var orgid = getOrgId(event);
                    window.location = "content.html?orgid=" + orgid;
                });

                $(".deleteOrgBtn").click(function(event){
                    var choice = confirm("This will delete the Org named " + getOrgName(event) + ", along with all users and data associated with it. Do you want to proceed?");
                    if(choice){
                        var orgid = getOrgId(event);
                        orgbuilder.api.call("orgs/" + orgid, orgbuilder.methods.delete)
                            .done(function(){
                                console.log("Org successfully deleted");
                                location.reload(true);
                            })
                            .fail(function(){
                                //TODO need better fail functionality
                                console.log("Org delete FAILED");
                            });
                    }
                });

                //TODO also add the ability to open the users page for the org
            })
            .fail(function(jqXHR){
                //TODO improve fail handling
                console.log("Get Orgs Request Failed: " + jqXHR.status + " " + jqXHR.statusText);
            });

        function getOrgId(event){
            return $(event.target).parents("tr[orgid]").attr("orgid");
        }

        function getOrgName(event){
            return $(event.target).parents("tr").children("td[field = 'orgName']").text();
        }

        $("#addOrgBtn").click(function(event){
            window.location = "content.html";
        });
    });
</script>
</body>
</html>