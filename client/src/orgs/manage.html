<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OrgBuilder - Manage Orgs</title>
    <link rel="stylesheet" type="text/css" href="../css/org-styles.css" />
</head>
<body>
    <h1>Manage Orgs</h1>
    <p>
        <a id="logoutButton" href="../index.html">Logout</a>
    </p>
    <p>
        <a id="mainMenuButton" href="../main.html">Main Menu</a>
    </p>

    <h3>Orgs</h3>

    <table id="orgsTable" border="1">
        <thead>
            <tr>
                <th>Org Name</th>
                <th>Created Date</th>
                <th>Options</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button id="addOrgBtn" type="button" title="Add new Org">A</button>

<script src="../jquery-3.1.1.js"></script>
<script src="../js/org-props.js"></script>
<script src="../js/orgbuilder.js"></script>
<script>
    $(document).ready(function(){
        //TODO need to check if user has master access for each page with master actions
        if(orgbuilder.jwt.getToken() === null){
            console.log("No access token");
            window.location = "access-denied.html";
            return;
        }

        var tableBody = $("#orgsTable tbody");

        //TODO need to add pagination
        orgbuilder.api.call("orgs", orgbuilder.methods.get)
            .done(function(data,status,jqXHR){
                //TODO need to be able to test that the data has the right contents
                $.each(data.orgList, function(index, org){
                    var newRow = $("<tr index='" + index + "' orgid='" + org.orgId + "'></tr>");
                    newRow.append($("<td></td>").text(org.orgName));
                    newRow.append($("<td></td>").text(org.createdDate));

                    var options = $("<td></td>");
                    options.append($("<button class='editOrgBtn' type='button' title='Edit Org'></button>").text("E"));
                    options.append($("<button class='deleteOrgBtn' type='button' title='Delete Org'></button>").text("D"));


                    newRow.append(options);
                    tableBody.append(newRow);
                });

                function getOrgId(event){
                    return $(event.target).parents("tr[orgid]").attr("orgid");
                }

                $(".editOrgBtn").click(function(event){
                    var orgid = getOrgId(event);
                    window.location = "content.html?orgid=" + orgid;
                });

                $(".deleteOrgBtn").click(function(event){
                    //TODO this needs a prompt warning of the effects of deleting an org
                    var orgid = getOrgId(event);
                    orgbuilder.api.call("orgs/" + orgid, orgbuilder.methods.delete)
                        .done(function(){
                            console.log("Org successfully deleted");
                            location.reload(true);
                        })
                        .fail(function(){
                            //TODO need better fail functionality
                            console.log("Org delete FAILED");
                        });
                });

                //TODO also add the ability to open the users page for the org
            })
            .fail(function(jqXHR){
                //TODO improve fail handling
                console.log("Get Orgs Request Failed: " + jqXHR.status + " " + jqXHR.statusText);
            });

        $("#logoutButton").click(orgbuilder.jwt.clearToken);
        $("#addOrgBtn").click(function(event){
            window.location = "content.html";
        });
    });
</script>
</body>

</html>